
include::attributes.adoc[]

[#2-protecting-apps-sso]
= {title}

// word count that fits best is 15-22, with 20 really being the sweet spot. Character count for that space would be 100-125
Learn how to setup Customer Application SSO to protect end-user applications by using standards such as OpenID Connect, OAuth 2.0, and SAML 2.0.

NOTE: You must complete the _{sp1-title}_ Solution Pattern before starting this one.

//If I make this a title, it breaks the layout.
*Welcome back to Cruddyâ€™s Car Parts*

In this Solution Pattern, you will continue to use the {create-messages-app} and the {retrieve-messages-app} applications from the _{sp1-title}_ Solution Pattern. Now, you will protect them from unauthorised access by creating and enabling a single sign-on service.

image::images/arch.png[integration, role="integr8ly-img-responsive"]

[type=walkthroughResource,serviceName=openshift]
.Red Hat OpenShift
****
* link:{openshift-host}/console[Console, window="_blank"]
* link:https://help.openshift.com/[OpenShift Online Help Center, window="_blank"]
* link:https://blog.openshift.com/[OpenShift Blog, window="_blank"]
****

[type=walkthroughResource,serviceName=3scale]
.{customer-sso-name}
****
* link:{sso-realm-url}[Shared SSO Realm, window="_blank"]
* link:https://access.redhat.com/products/red-hat-single-sign-on/[Red Hat Single Sign-On Overview, window="_blank"]
****

:sectnums:

[time=7]
== Creating a client

SSO uses *Realms* to manage *Clients*, *Roles*, *Users* and *Groups*. A
user belongs to and logs into a realm. Realms are isolated from one another and
can only manage and authenticate the users that they control.

NOTE: The `walkthroughs` realm used in this Solution Pattern is shared with all users on the cluster. Do not use this realm for production applications.


Securing an application using SSO requires a *Client* to be created in
a *Realm*. The *Client* represents the application being secured and contains
important details regarding the security applied to the application.

. Navigate to the link:{sso-realm-url}[SSO Realm, window="_blank"].
. Enter the username `walkthroughs` and password `password` if prompted.
. Details for the `walkthroughs` realm are displayed upon login success.
. Select *Clients* from the menu on the left.
. Click the *Create* button at the top of the list of clients to display the *Add Client* screen:
.. Enter `{client-name}` in the *Client ID* field.
.. Verify *Client Protocol* is set to `openid-connect`.
.. Paste the URL of the *{create-messages-app} UI* from the *Integrating message-oriented middleware with a RESTful API using AMQ Online* Solution Pattern in the *Root URL* field. This should look similar to `https://order-entry-ui-{user-username}-<NAMESPACE>.{openshift-app-host}`
.. Click *Save*.
. The *Settings* screen for the `{client-name}` client should be displayed.
. Verify that the *Access Type* field is set to `public`. This means the client is a frontend application that needs to log in using a web browser.

[type=verification]
Select *Clients* in the side menu.
Is the `{client-name}` client listed and is the *Enabled* field set to `True`?

[type=verificationFail]
In the *Settings* tab on the *Client* page, make sure that the *Enabled* toggle is set to *ON*. {standard-fail-text}

[time=7]
== Creating a User

Red Hat Single Sign-On provides identity brokering functionality, which facilitates login using a shared identity. For example, it is possible
to create an *Identity Provider* in a *Realm* in SSO to enable login
using social identities such as Google, Twitter, or GitHub. When the user
chooses to login using an *Identity Provider* a *User* is automatically created
in the SSO *Realm* with the details from their chosen
*Identity Provider*.

In this Solution Pattern a *User* will be created manually to keep things
simple.

. Navigate to the link:{sso-realm-url}[SSO Realm, window="_blank"].
. Enter the username `{shared-realm-username}` and password `password` if prompted.
. Select the *Users* entry in the side menu.
. Click *Add user*.
.. Enter the username `customer`.
.. Leave other fields with their default values and click *Save*.
. The `customer` user details should now be displayed with tabs along the top of the UI.
. Select the *Credentials* tab.
.. Enter the password `customer-password` in the *New Password* field.
.. Enter the same password in the *Password Confirmation* field.
.. Set the *Temporary* toggle to the *OFF* position.
+
NOTE: If we left *Temporary* in the *ON* position the user would be forced to create a new password when they perform a login.
.. Click the *Reset Password* button.
.. When prompted click the *Change password* button in the modal.

[type=verification]
Select the *Users* item in the side menu. Click the *View all users* button. Is the `customer` user listed?

[type=verificationFail]
{standard-fail-text}

[time=15]
== Enabling SSO in the {create-messages-app}

=== Obtaining the SSO Configuration

To secure an application with SSO a *Client Adapter* is required.
Various platforms are supported with *Client Adapters*:

* Spring Boot
* Node.js
* JBoss EAP
* Fuse
* JavaScript (client-side)
* Servlet Filter

{blank}

The *{create-messages-app}* is run from a Node.js server, so the Node.js
`keycloak-connect` adapter is included in the code. The following steps will
demonstrate how to include a configuration and enable the adapter.


. Navigate to the link:{sso-realm-url}[SSO Realm, window="_blank"].
. Enter the username `{shared-realm-username}` and password `password` if prompted.
. Select *Clients* from the side menu.
. Click the `{client-name}` client that was created earlier.
. Choose the *Installation* tab.
. Select *Keycloak OIDC JSON* for *Format Option*.
. Click the *Download* button to download this as a _keycloak.json_ file.

=== Creating a SSO Config Map Entry

. Login to the link:{openshift-host}/console/[OpenShift Console, window="_blank"].
. Select the project that contains *walkthroughs-1A-integrate-event-and-api-driven-apps* in the name.
. Select *Resources > Config Maps*.
. Click the *Create Config Map*  button.
.. Enter `order-entry-keycloak-config` in the *Name* field.
.. Enter `KEYCLOAK_CONFIG` in the *Key* field.
.. Click the *Browse* button and select the _keycloak.json_ file that was downloaded in the previous section.
. Click the *Create* button.

=== Applying the SSO Config Map

. Log in to the link:{openshift-host}/console/[OpenShift Console, window="_blank"].
. Navigate to the *walkthroughs-1A-integrate-event-and-api-driven-apps* project.
. Select *Applications > Deployments*.
. Select the *rhmi-lab-nodejs-order-frontend* item from the *Deployments* list.
. Select the *Environment* tab.
.. Click *Add Value from Config Map or Secret*
.. Enter `KEYCLOAK_CONFIG` in the *Name* column.
.. Choose `order-entry-keycloak-config` from the *Select a resource* dropdown.
.. Choose *KEYCLOAK_CONFIG* from the *Select key* menu.
. Scroll down and click *Save*.
. Select *Overview* on the left and find the *rhmi-lab-nodejs-order-frontend* in the list.
. If a deployment is still in progress, wait for it to finish.
. Open the URL listed beside the *rhmi-lab-nodejs-order-frontend* in either a private browser session, or a different browser to view the *{create-messages-app}* UI.
+
NOTE: Use a private session or different browser to avoid conflict with your old sessions.

. A login screen with the title *walkthroughs Realm* is displayed.
. Enter `customer` in the *Username or email*.
. Enter `customer-password` in the *Password* field.
. Click the *Log In* button.

[type=verification]
The login should be successful. Is the *{create-messages-app}* web application displayed?

[type=verificationFail]
If a login page is not presented try opening the *{create-messages-app}* in a private browsing session or different browser. {standard-fail-text}

[type=taskResource]
.Task Resources
****
* link:{sso-adapter-docs-url}[Securing Applications and Services with SSO, window="_blank"]
****
